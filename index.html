<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üåê Global Chat</title>
<style>
  :root {
    --bg: #1e1e2f;
    --panel: #2a2a3f;
    --card: #2f2f4b;
    --text: #ffffff;
    --muted: #b9bed1;
    --accent: #4a90e2;
    --accent-hover: #357ab8;
    --warn: #ffb703;
    --warn-hover: #e09c04;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; height: 100vh; display: flex; flex-direction: column;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg); color: var(--text);
  }
  #header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 1rem; background: var(--panel);
    border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,.25);
  }
  #header h2 { margin: 0; font-weight: 700; }
  #profileBtn {
    padding: .55rem .9rem; border: 0; border-radius: 10px; cursor: pointer;
    background: var(--warn); color: #000; font-weight: 700;
  }
  #profileBtn:hover { background: var(--warn-hover); }

  #messages {
    flex: 1; overflow-y: auto; padding: 1rem;
    display: flex; flex-direction: column; gap: .6rem;
  }
  .msg {
    display: flex; align-items: flex-start; gap: .6rem;
    background: var(--card); border-radius: 14px; padding: .6rem .75rem;
  }
  .avatar {
    width: 36px; height: 36px; border-radius: 50%;
    display: grid; place-items: center; flex-shrink: 0;
    background: #4b4f6a; color: #fff; font-weight: 800; font-size: .85rem;
  }
  .mine .avatar { background: var(--accent); }
  .msgContent { flex: 1; min-width: 0; }
  .meta {
    font-size: .75rem; color: var(--muted);
    display: flex; align-items: center; gap: .35rem; flex-wrap: wrap;
    margin-bottom: .25rem;
  }
  .meta .spacer { margin: 0 .25rem; opacity: .5; }
  .actions {
    display: inline-flex; gap: .25rem; margin-left: .25rem;
  }
  .actions button {
    border: 0; border-radius: 6px; padding: 2px 6px; cursor: pointer;
    background: #50546e; color: #fff; font-size: .7rem;
  }
  .actions button:hover { filter: brightness(1.1); }

  .text {
    white-space: pre-wrap; word-break: break-word; font-size: .95rem;
  }
  .editInput {
    width: 100%; padding: .4rem .55rem; border-radius: 8px; border: 0;
    outline: none; background: #1f1f30; color: #fff; font-size: .95rem;
  }

  #typing {
    font-size: .8rem; color: #aaa; padding: 0 .9rem .25rem .9rem;
  }

  #inputArea {
    display: flex; align-items: center; gap: .5rem;
    padding: .6rem; border-top: 1px solid #3a3a52; background: var(--panel);
    border-top-left-radius: 12px; border-top-right-radius: 12px;
    box-shadow: 0 -2px 6px rgba(0,0,0,.25);
  }
  #msgInput {
    flex: 1; min-height: 42px; max-height: 160px; resize: none;
    padding: .6rem .75rem; border-radius: 12px; border: 0; outline: none;
    background: #1f1f30; color: #fff; line-height: 1.35; font-size: .95rem;
  }
  #sendBtn {
    padding: .6rem 1.1rem; border: 0; border-radius: 12px; cursor: pointer;
    background: var(--accent); color: #fff; font-weight: 700;
  }
  #sendBtn:hover { background: var(--accent-hover); }

  /* Profile modal */
  #profileModal {
    position: fixed; inset: 0; display: none; place-items: center;
    background: rgba(0,0,0,.55); padding: 1rem;
  }
  #profileCard {
    background: var(--panel); border-radius: 12px; padding: 1rem 1.1rem; width: 100%; max-width: 360px;
    box-shadow: 0 10px 30px rgba(0,0,0,.4);
  }
  #profileCard h3 { margin: 0 0 .75rem 0; }
  .field {
    display: grid; gap: .35rem; margin-bottom: .8rem;
  }
  .field input {
    padding: .55rem .7rem; border-radius: 10px; border: 0; outline: none;
    background: #1f1f30; color: #fff; font-size: .95rem;
  }
  .row { display: flex; gap: .5rem; justify-content: flex-end; }
  .row button {
    padding: .5rem .8rem; border: 0; border-radius: 10px; cursor: pointer; font-weight: 700;
  }
  #saveUsername { background: var(--accent); color: #fff; }
  #closeProfile { background: #4b4f6a; color: #fff; }

  /* Small screens polish */
  @media (max-width: 520px) {
    #header h2 { font-size: 1.05rem; }
    #sendBtn { padding: .55rem .85rem; }
    #profileBtn { padding: .5rem .75rem; }
  }
</style>
</head>
<body>

  <div id="header">
    <h2>üåê Global Chat</h2>
    <button id="profileBtn">Profile</button>
  </div>

  <div id="typing"></div>
  <div id="messages" aria-live="polite"></div>

  <div id="inputArea">
    <textarea id="msgInput" placeholder="Type a message‚Ä¶" rows="1"></textarea>
    <button id="sendBtn">Send</button>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal">
    <div id="profileCard">
      <h3>Profile</h3>
      <div class="field">
        <label for="usernameInput">Username</label>
        <input id="usernameInput" type="text" maxlength="24" />
      </div>
      <div class="row">
        <button id="closeProfile">Cancel</button>
        <button id="saveUsername">Save</button>
      </div>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    /* Firebase SDKs */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getDatabase, ref, push, onValue, update, set, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    /* Your Firebase project config */
    const firebaseConfig = {
      apiKey: "AIzaSyBjjkq13CsczarMbw-t7KQ2juTo2sS_hI0",
      authDomain: "tic-tac-toe-14b74.firebaseapp.com",
      databaseURL: "https://tic-tac-toe-14b74-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tic-tac-toe-14b74",
      storageBucket: "tic-tac-toe-14b74.firebasestorage.app",
      messagingSenderId: "437051772100",
      appId: "1:437051772100:web:23617dbfe45f09cd2ccd91"
    };

    /* Initialize Firebase */
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    /* DOM */
    const messagesEl   = document.getElementById('messages');
    const typingEl     = document.getElementById('typing');
    const msgInput     = document.getElementById('msgInput');
    const sendBtn      = document.getElementById('sendBtn');
    const profileBtn   = document.getElementById('profileBtn');
    const profileModal = document.getElementById('profileModal');
    const usernameIn   = document.getElementById('usernameInput');
    const saveUsername = document.getElementById('saveUsername');
    const closeProfile = document.getElementById('closeProfile');

    /* Identity */
    let username = localStorage.getItem('gc_username') || `User-${Math.random().toString(36).slice(2,6)}`;
    localStorage.setItem('gc_username', username);
    profileBtn.textContent = `Profile (${username})`;

    /* Refs */
    const messagesRef = ref(db, 'messages');
    const typingRef   = ref(db, 'typing');

    /* Helpers */
    function timeStr(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function autoGrow(el) {
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + 'px';
    }

    /* Send message */
    async function sendMessage() {
      const text = msgInput.value.trim();
      if (!text) return;
      await push(messagesRef, {
        user: username,
        text,
        ts: serverTimestamp()
      });
      msgInput.value = '';
      autoGrow(msgInput);
    }

    /* Inline edit */
    function beginEdit(key, currentText, container, textDiv) {
      const input = document.createElement('textarea');
      input.className = 'editInput';
      input.value = currentText;
      input.rows = Math.min(6, Math.max(1, currentText.split('\n').length));
      container.replaceChild(input, textDiv);
      input.focus();
      input.select();

      const commit = async () => {
        const newText = input.value.trim();
        await update(ref(db, 'messages/' + key), { text: newText });
      };
      const cancel = () => {
        container.replaceChild(textDiv, input);
      };

      input.addEventListener('keydown', (e) => {
        if ((e.key === 'Enter' && !e.shiftKey)) {
          e.preventDefault();
          commit();
        } else if (e.key === 'Escape') {
          cancel();
        }
      });
      input.addEventListener('blur', commit);
    }

    /* Delete message */
    async function deleteMessage(key) {
      if (!confirm('Delete this message?')) return;
      await set(ref(db, 'messages/' + key), null);
    }

    /* Typing indicator:
       - Write a "last typed" timestamp under /typing/<username>
       - Show others typing if their timestamp within last 5 seconds */
    function touchTyping() {
      // Use local clock for comparison consistency
      set(ref(db, 'typing/' + username), Date.now());
    }

    /* Events: send & input */
    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    msgInput.addEventListener('input', () => {
      autoGrow(msgInput);
      touchTyping();
    });

    /* Profile */
    profileBtn.addEventListener('click', () => {
      usernameIn.value = username;
      profileModal.style.display = 'grid';
      usernameIn.focus();
      usernameIn.select();
    });
    closeProfile.addEventListener('click', () => {
      profileModal.style.display = 'none';
    });
    saveUsername.addEventListener('click', () => {
      const v = usernameIn.value.trim();
      if (!v) return;
      username = v;
      localStorage.setItem('gc_username', username);
      profileBtn.textContent = `Profile (${username})`;
      profileModal.style.display = 'none';
    });
    // Close modal on backdrop click
    profileModal.addEventListener('click', (e) => {
      if (e.target === profileModal) profileModal.style.display = 'none';
    });

    /* Listen typing */
    onValue(typingRef, (snap) => {
      const data = snap.val() || {};
      const now = Date.now();
      const others = Object.entries(data)
        .filter(([name, t]) => name !== username && typeof t === 'number' && (now - t) < 5000)
        .map(([name]) => name);
      typingEl.textContent = others.length ? `${others.join(', ')} ${others.length > 1 ? 'are' : 'is'} typing‚Ä¶` : '';
    });

    /* Listen messages */
    onValue(messagesRef, async (snap) => {
      const raw = snap.val() || {};
      let entries = Object.entries(raw)
        .map(([k, v]) => ({ key: k, ...v }))
        // When using serverTimestamp, ts arrives as a number later; fallback sort by key if missing
        .sort((a, b) => (a.ts || 0) - (b.ts || 0) || a.key.localeCompare(b.key));

      // Trim: if >= 50, delete oldest so only last 10 remain
      if (entries.length >= 50) {
        const toDelete = entries.slice(0, entries.length - 10);
        // fire-and-forget deletions
        toDelete.forEach(({ key }) => set(ref(db, 'messages/' + key), null));
        entries = entries.slice(-10);
      }

      // Render
      messagesEl.innerHTML = '';
      entries.forEach((m) => {
        const mine = m.user === username;

        const row = document.createElement('div');
        row.className = 'msg' + (mine ? ' mine' : '');

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = (m.user || '?').slice(0, 2).toUpperCase();

        const content = document.createElement('div');
        content.className = 'msgContent';

        const meta = document.createElement('div');
        meta.className = 'meta';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = m.user || 'Unknown';
        const timeSpan = document.createElement('span');
        timeSpan.textContent = timeStr(m.ts);
        const dot = document.createElement('span');
        dot.className = 'spacer';
        dot.textContent = '‚Ä¢';
        meta.appendChild(nameSpan);
        meta.appendChild(dot);
        meta.appendChild(timeSpan);

        if (mine) {
          const actions = document.createElement('span');
          actions.className = 'actions';
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', () => beginEdit(m.key, m.text || '', content, textDiv));
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Delete';
          delBtn.addEventListener('click', () => deleteMessage(m.key));
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
          meta.appendChild(actions);
        }

        const textDiv = document.createElement('div');
        textDiv.className = 'text';
        textDiv.textContent = m.text || '';

        content.appendChild(meta);
        content.appendChild(textDiv);

        row.appendChild(avatar);
        row.appendChild(content);
        messagesEl.appendChild(row);
      });

      // Scroll to bottom
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    // Initialize textarea height once
    autoGrow(msgInput);
  </script>
</body>
</html>